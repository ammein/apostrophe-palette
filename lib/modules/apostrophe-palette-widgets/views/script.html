{% macro newRule(value, fieldSchema) %}
  {%- if fieldSchema.selector and (value !== null or value !== undefined) -%}
    {%- if not apos.global.aposPaletteIsArray(fieldSchema.property) -%}
      {%- set props = [ fieldSchema.property ] -%}
    {%- else -%}
      {%- set props = fieldSchema.property -%}
    {% endif %}
    {%- if not apos.global.aposPaletteIsArray(fieldSchema.selector) -%}
      {%- set selectors = [ fieldSchema.selector ] -%}
    {%- else -%}
      {%- set selectors = fieldSchema.selector -%}
    {%- endif -%}
    {%- for property in props -%}
      {%- for selector in selectors -%}
        {% if fieldSchema.mediaQuery %}@media {{ fieldSchema.mediaQuery }} { {% endif %}{{ selector }} { {{ property }}: {{ value }}{% if fieldSchema.unit %}{{ fieldSchema.unit }}{% endif %}; }{% if fieldSchema.mediaQuery %} } {% endif %}
      {%- endfor -%}
    {%- endfor -%}
  {%- endif -%}
{% endmacro %}

{% macro tag(apos, global) %}
  <style id="apos-palette-styles" data-apos-palette-styles>
    {%- for key, value in global -%}
      {% set fieldSchema = apos.global.aposPaletteGetFieldSchema(key)  %}
      {%- if (fieldSchema) -%}
        {{ newRule(value, fieldSchema) }}
      {%- endif -%}
    {% endfor %}
  </style>
{% endmacro %}